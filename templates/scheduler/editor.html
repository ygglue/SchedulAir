{% extends 'scheduler/base.html' %}
{% load index %}
{% block title %}
Schedule Editor
{% endblock %}

{% block content %}
<section class="container schedule-container">
  <div class="dashboard-card weather-board shadow-xxl h-100 mb-4">
    <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center">
      <div>
        <h1 class="schedule-page-title">Class Schedule</h1>
        <p class="schedule-page-date">{{current_date}}</p>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-gradient rounded-pill px-3" data-bs-toggle="modal"
          data-bs-target="#createModal"><i class="bi bi-plus-lg me-1"></i>Add</button>
      </div>
    </div>
  </div>

  <div class="dashboard-card weather-board shadow-xxl h-100">
    <div class="week-days-header d-none d-lg-grid">
      {% for day in days_of_week %}
        {% if day == current_day_abbr %}
          <div class="week-day-header active">{{day}}</div>
        {% else %}
          <div class="week-day-header">
            {{day}}
            {% if weather_icons|index:forloop.counter0 != "" %}
              <img class="weather-icon" src="{{weather_icons|index:forloop.counter0}}" alt="weather-icon-img">
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
    <div class="week-schedule-grid">
      <div class="day-column">
        {% if current_day_abbr == "Sun" %}
          <div class="week-day-header d-lg-none mb-3 active">Sun</div>
        {% else %}
          <div class="week-day-header d-lg-none mb-3">Sun
            {% if weather_icons.6 != "" %}
              <img class="weather-icon" src="{{weather_icons.6}}" alt="weather-icon-img">
            {% endif %}
          </div>
        {% endif %}
        {% if sun_classes %}
          {% for class in sun_classes %}
            <div class="class-block block-purple" data-duration="2h" data-class-id="{{ class.id }}" data-day="SUN" data-start="{{ class.start_time|time:'H:i' }}" data-end="{{ class.end_time|time:'H:i' }}" data-bs-toggle="modal" data-bs-target="#editModal">
              <div class="class-time">{{ class.start_time|time:"g:i A" }} - {{ class.end_time|time:"g:i A" }}</div>
              <div class="class-name">{{ class.subject.name }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="class-empty">No classes</div>
        {% endif %}
      </div>
      <div class="day-column">
        {% if current_day_abbr == "Mon" %}
          <div class="week-day-header d-lg-none mb-3 active">Mon</div>
        {% else %}
          <div class="week-day-header d-lg-none mb-3">Mon
            {% if weather_icons.0 != "" %}
              <img class="weather-icon" src="{{weather_icons.0}}" alt="weather-icon-img">
            {% endif %}
          </div>
        {% endif %}
        {% if mon_classes %}
          {% for class in mon_classes %}
            <div class="class-block block-purple" data-duration="2h" data-class-id="{{ class.id }}" data-day="MON" data-start="{{ class.start_time|time:'H:i' }}" data-end="{{ class.end_time|time:'H:i' }}" data-bs-toggle="modal" data-bs-target="#editModal">
              <div class="class-time">{{ class.start_time|time:"g:i A" }} - {{ class.end_time|time:"g:i A" }}</div>
              <div class="class-name">{{ class.subject.name }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="class-empty">No classes</div>
        {% endif %}
      </div>
      <div class="day-column">
        {% if current_day_abbr == "Tue" %}
          <div class="week-day-header d-lg-none mb-3 active">Tue</div>
        {% else %}
          <div class="week-day-header d-lg-none mb-3">Tue
            {% if weather_icons.1 != "" %}
              <img class="weather-icon" src="{{weather_icons.1}}" alt="weather-icon-img">
            {% endif %}
          </div>
        {% endif %}
        {% if tue_classes %}
          {% for class in tue_classes %}
            <div class="class-block block-purple" data-duration="2h" data-class-id="{{ class.id }}" data-day="TUE" data-start="{{ class.start_time|time:'H:i' }}" data-end="{{ class.end_time|time:'H:i' }}" data-bs-toggle="modal" data-bs-target="#editModal">
              <div class="class-time">{{ class.start_time|time:"g:i A" }} - {{ class.end_time|time:"g:i A" }}</div>
              <div class="class-name">{{ class.subject.name }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="class-empty">No classes</div>
        {% endif %}
      </div>
      <div class="day-column">
        {% if current_day_abbr == "Wed" %}
          <div class="week-day-header d-lg-none mb-3 active">Wed</div>
        {% else %}
          <div class="week-day-header d-lg-none mb-3">Wed
            {% if weather_icons.2 != "" %}
              <img class="weather-icon" src="{{weather_icons.2}}" alt="weather-icon-img">
            {% endif %}
          </div>
        {% endif %}
        {% if wed_classes %}
          {% for class in wed_classes %}
            <div class="class-block block-purple" data-duration="2h" data-class-id="{{ class.id }}" data-day="WED" data-start="{{ class.start_time|time:'H:i' }}" data-end="{{ class.end_time|time:'H:i' }}" data-bs-toggle="modal" data-bs-target="#editModal">
              <div class="class-time">{{ class.start_time|time:"g:i A" }} - {{ class.end_time|time:"g:i A" }}</div>
              <div class="class-name">{{ class.subject.name }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="class-empty">No classes</div>
        {% endif %}
      </div>
      <div class="day-column">
        {% if current_day_abbr == "Thu" %}
          <div class="week-day-header d-lg-none mb-3 active">Thu</div>
        {% else %}
          <div class="week-day-header d-lg-none mb-3">Thu
            {% if weather_icons.3 != "" %}
              <img class="weather-icon" src="{{weather_icons.3}}" alt="weather-icon-img">
            {% endif %}
          </div>
        {% endif %}
        {% if thu_classes %}
          {% for class in thu_classes %}
            <div class="class-block block-purple" data-duration="2h" data-class-id="{{ class.id }}" data-day="THU" data-start="{{ class.start_time|time:'H:i' }}" data-end="{{ class.end_time|time:'H:i' }}" data-bs-toggle="modal" data-bs-target="#editModal">
              <div class="class-time">{{ class.start_time|time:"g:i A" }} - {{ class.end_time|time:"g:i A" }}</div>
              <div class="class-name">{{ class.subject.name }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="class-empty">No classes</div>
        {% endif %}
      </div>
      <div class="day-column">
        {% if current_day_abbr == "Fri" %}
          <div class="week-day-header d-lg-none mb-3 active">Fri</div>
        {% else %}
          <div class="week-day-header d-lg-none mb-3">Fri
            {% if weather_icons.4 != "" %}
              <img class="weather-icon" src="{{weather_icons.4}}" alt="weather-icon-img">
            {% endif %}
          </div>
        {% endif %}
        {% if fri_classes %}
          {% for class in fri_classes %}
            <div class="class-block block-purple" data-duration="2h" data-class-id="{{ class.id }}" data-day="FRI" data-start="{{ class.start_time|time:'H:i' }}" data-end="{{ class.end_time|time:'H:i' }}" data-bs-toggle="modal" data-bs-target="#editModal">
              <div class="class-time">{{ class.start_time|time:"g:i A" }} - {{ class.end_time|time:"g:i A" }}</div>
              <div class="class-name">{{ class.subject.name }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="class-empty">No classes</div>
        {% endif %}
      </div>
      <div class="day-column">
        {% if current_day_abbr == "Sat" %}
          <div class="week-day-header d-lg-none mb-3 active">Sat</div>
        {% else %}
          <div class="week-day-header d-lg-none mb-3">Sat
            {% if weather_icons.5 != "" %}
              <img class="weather-icon" src="{{weather_icons.5}}" alt="weather-icon-img">
            {% endif %}
          </div>
        {% endif %}
        {% if sat_classes %}
          {% for class in sat_classes %}
            <div class="class-block block-purple" data-duration="2h" data-class-id="{{ class.id }}" data-day="SAT" data-start="{{ class.start_time|time:'H:i' }}" data-end="{{ class.end_time|time:'H:i' }}" data-bs-toggle="modal" data-bs-target="#editModal">
              <div class="class-time">{{ class.start_time|time:"g:i A" }} - {{ class.end_time|time:"g:i A" }}</div>
              <div class="class-name">{{ class.subject.name }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="class-empty">No classes</div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-3">
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Edit Class Section -->
        <h2 class="modal-title-custom modal-section-title mb-3">Edit Class</h2>
        <form class="row g-3" id="editClassForm" method="POST">
          {% csrf_token %}
          <input type="hidden" id="editClassId" name="editClassId" value="">
          <div class="col-md-6">
            <label for="editSubjectSelect" class="modal-label">Subject</label>
            <select class="form-select" id="editSubjectSelect" name="editSubjectSelect" required>
              {% for subject in subjects %}
                <option value="{{subject.id}}">{{subject.name}}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="editClassDay" class="modal-label">Day</label>
            <select class="form-select" id="editClassDay" name="editClassDay" required>
              <option value="SUN">Sunday</option>
              <option value="MON">Monday</option>
              <option value="TUE">Tuesday</option>
              <option value="WED">Wednesday</option>
              <option value="THU">Thursday</option>
              <option value="FRI">Friday</option>
              <option value="SAT">Saturday</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="editStartTime" class="modal-label">Start Time</label>
            <input type="time" class="form-control" id="editStartTime" name="editStartTime" required/>
          </div>
          <div class="col-md-6">
            <label for="editEndTime" class="modal-label">End Time</label>
            <input type="time" class="form-control" id="editEndTime" name="editEndTime" required/>
          </div>
        </form>
        <div class="alert alert-warning d-none mt-2 w-100" id="editClassError" role="alert"></div>
      </div>
      <div class="modal-footer border-0 pt-3 justify-content-between">
        <button type="button" class="btn btn-outline-light rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#deleteModal">
          Delete
        </button>
        <button type="submit" form="editClassForm" class="btn btn-gradient rounded-pill px-4">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-3">
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h2 class="modal-title-custom modal-section-title mb-3">Are you sure you want to delete?</h2>
        <form class="row g-3" id="deleteClassForm" method="POST">
          {% csrf_token %}
          <input type="hidden" id="deleteClassId" name="deleteClassId" value="">
        </form>
      </div>
      <div class="modal-footer border-0 pt-3 justify-content-center">
        <button type="submit" form="deleteClassForm" class="btn btn-gradient rounded-pill px-4">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Create Modal -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-3">
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Add Subject Section -->
        <div class="modal-section-divider">
          <h2 class="modal-title-custom modal-section-title mb-3">Add Subject</h2>
          <form class="row g-3" id="addSubjectForm">
            {% csrf_token %}
            <div class="col-md-8 d-flex flex-column">
              <div class="mb-3">
                <label for="subjectName" class="modal-label">Subject Name</label>
                <input type="text" class="form-control" id="subjectName" name="subjectName" placeholder="e.g. Computer Science" required/>
              </div>
              <div>
                <label for="instructor" class="modal-label">Instructor</label>
                <input type="text" class="form-control" id="instructor" name="instructor" placeholder="Name" required/>
              </div>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button type="submit" class="btn btn-gradient rounded-pill px-4 w-100 mb-0" name="addSub">Add Subject</button>
            </div>
          </form>
          <div style="color: white;" id="formMessage"></div>
        </div>
        
        <!-- Add Class Section -->
        <h2 class="modal-title-custom modal-section-title mb-3">Add Class</h2>
        <form class="row g-3" id="addClassForm" method="POST">
          {% csrf_token %}
          <div class="col-md-6">
            <label for="subjectSelect" class="modal-label">Subject</label>
            <select class="form-select" id="subjectSelect" name="subjectSelect" required>
            {% if subjects %}
              <option id="choose-option" selected>Choose...</option>
              {% for subject in subjects %}
                <option value="{{subject.id}}">{{subject.name}}</option>
              {% endfor %}
            {% else %}
              <option class="modal-empty-message" id="empty-message">No Subjects added yet...</option>
            {% endif %}
            </select>
          </div>
          <div class="col-md-6">
            <label for="classDay" class="modal-label">Day</label>
            <select class="form-select" id="classDay" name="classDay" required>
              <option value="" selected>Choose...</option>
              <option value="SUN">Sunday</option>
              <option value="MON">Monday</option>
              <option value="TUE">Tuesday</option>
              <option value="WED">Wednesday</option>
              <option value="THU">Thursday</option>
              <option value="FRI">Friday</option>
              <option value="SAT">Saturday</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="startTime" class="modal-label">Start Time</label>
            <input type="time" class="form-control" id="startTime" name="startTime" required/>
          </div>
          <div class="col-md-6">
            <label for="endTime" class="modal-label">End Time</label>
            <input type="time" class="form-control" id="endTime" name="endTime" required/>
          </div>
        </form>
        <div class="alert alert-warning d-none mt-2 w-100" id="addClassError" role="alert"></div>
      </div>
      <div class="modal-footer border-0 pt-3">
        <button type="button" class="btn btn-outline-light rounded-pill px-4" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="submit" form="addClassForm" class="btn btn-gradient rounded-pill px-4">Add Class</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
